---
title: "Scottish Health Survey Gambling Data"
author: "Scott Kilgariff"
date: "08/07/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Data extracted from <a href = "https://www.gov.scot/collections/scottish-health-survey/", target = "_blank"> Scottish Health Survey </a> (SHS) covering the period from 2012 to 2017.

Data for 2021 is expected to be made available in November 2022. Questions on gambling were not included in the SHS during the years 2018 to 2020.

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(readxl)
library(httr)
library(janitor)
library(ggplot2)
library(viridis)

create_plot <- function(df_plot_slice, y_lab){
    p <- ggplot(df_plot_slice, aes(year, category, fill=value)) +
    geom_raster() +
    scale_fill_viridis(direction = -1, option = "B", begin = 0.25, end = 0.75, alpha = 0.5) +
    geom_hline(yintercept=c(1.5,2.5,3.5,4.5,5.5,6.5,7.5)) +
    geom_text(aes(label = round(value, 1))) +
    ylab(y_lab) +
    theme_classic() + 
    facet_wrap(~ sex, labeller = label_wrap_gen(), ncol=3) +
    theme(panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      strip.background = element_blank(),
      panel.border = element_rect(colour = NA, fill = NA),
      strip.text = element_text(size = 15),
      axis.text = element_text(size = 12))
    
    return(p)
}

```

## Percentage of respondents answering "Yes" to spending money on the following, split by age group

```{r grid_1, out.width = "100%", echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3, ,results="asis"}

df_data <- read_csv("df_sheet.csv")

df_plot <- df_data %>% 
  filter(response_map == "Yes" & 
           description =="age_grp" &
           !is.na(measure_map))

df_plot$measure_map <- gsub('Spent any money on:', '', df_plot$measure_map)
df_plot$measure_map <- gsub('Spent money on:', '', df_plot$measure_map)

measures <- unique(df_plot$measure_map)

for (i in seq_along(measures)){
  
  cat("  \n###",  measures[i], "  \n")
  
  df_plot_slice <- df_plot %>% filter(measure_map == measures[i])
  
  y_lab <- "Age groups"

  plot <- create_plot(df_plot_slice, y_lab)
  
  print(plot)
  
  cat("  \n")
}

```

## Percentage of respondents answering "Yes" to spending money on the following, split by SIMD deprivation quintile

```{r grid_2, out.width = "100%", echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3, ,results="asis"}

df_plot <- df_data %>% 
  filter(response_map == "Yes" & 
           description =="simd_quintiles"&
           !is.na(measure_map))

df_plot$measure_map <- gsub('Spent any money on:', '', df_plot$measure_map)
df_plot$measure_map <- gsub('Spent money on:', '', df_plot$measure_map)

df_plot$category <- ordered(df_plot$category, levels = c("least_deprived", "x4", "x3", "x2", "most_deprived"))

measures <- unique(df_plot$measure_map)

for (i in seq_along(measures)){
  
  cat("  \n###",  measures[i], "  \n")
  
  df_plot_slice <- df_plot %>% filter(measure_map == measures[i])
  
  y_lab <- "SIMD quintiles"

  plot <- create_plot(df_plot_slice, y_lab)
  
  print(plot)
  
  cat("  \n")
}

```

## Percentage of respondents answering "Yes" to spending money on the following, split by equivalised income quintiles

```{r grid_3, out.width = "100%", echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=3, ,results="asis"}

df_plot <- df_data %>% 
  filter(response_map == "Yes" & 
           description =="equivalised_income" &
           !is.na(measure_map))

df_plot$measure_map <- gsub('Spent any money on:', '', df_plot$measure_map)
df_plot$measure_map <- gsub('Spent money on:', '', df_plot$measure_map)

df_plot$category <- ordered(df_plot$category, levels = c("top_quintile", "x2", "x3", "x4", "bottom_quintile"))

measures <- unique(df_plot$measure_map)


for (i in seq_along(measures)){
  
  cat("  \n###",  measures[i], "  \n")
  
  df_plot_slice <- df_plot %>% filter(measure_map == measures[i])
  
  y_lab <- "Income quintiles"

  plot <- create_plot(df_plot_slice, y_lab)
  
  print(plot)
  
  cat("  \n")
}

```

